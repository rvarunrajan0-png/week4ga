name: CD Pipeline - Build and Deploy IRIS API

on:
  push:
    branches: [ main ]  # Deploy only when code reaches main

env:
  PROJECT_ID: iris-mlops-arun-2025
  GAR_LOCATION: asia-south1
  REPO_NAME: iris-api
  IMAGE_NAME: iris-api
  CLUSTER_NAME: iris-cluster
  GKE_REGION: asia-south1

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # Step 1: Checkout the repo
    - name: Checkout repository
      uses: actions/checkout@v3

    # Step 2: Authenticate with GCP using service account key
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    # Step 3: Set up Google Cloud SDK
    - name: Set up Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}

    # Step 4: Install GKE auth plugin (for kubectl authentication)
    - name: Install GKE auth plugin
      run: |
        sudo apt-get update
        sudo apt-get install -y google-cloud-sdk-gke-gcloud-auth-plugin
        echo "export USE_GKE_GCLOUD_AUTH_PLUGIN=True" >> $GITHUB_ENV

    # Step 5: Configure Docker for Artifact Registry
    - name: Configure Docker for Artifact Registry
      run: |
        gcloud auth configure-docker "$GAR_LOCATION-docker.pkg.dev" --quiet

    # Step 6: Build Docker image for the API
    - name: Build Docker image
      run: |
        docker build -t $GAR_LOCATION-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/$IMAGE_NAME:${{ github.sha }} .

    # Step 7: Push the built image to Artifact Registry
    - name: Push image to Artifact Registry
      run: |
        docker push $GAR_LOCATION-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/$IMAGE_NAME:${{ github.sha }}

    # Step 8: Connect to GKE cluster
    - name: Get GKE credentials
      run: |
        gcloud container clusters get-credentials $CLUSTER_NAME --region $GKE_REGION --project $PROJECT_ID

    # Step 9: Deploy to GKE (update image or apply YAML if missing)
    - name: Deploy to GKE
      run: |
        kubectl set image deployment/iris-api iris-api=$GAR_LOCATION-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/$IMAGE_NAME:${{ github.sha }} || \
        kubectl apply -f k8s/
